tab1_server <- function(input, output, session) {
# 创建 PDF 输出目录
if (!dir.exists("pdf_outputs")) {
dir.create("pdf_outputs")
}
# 辅助函数：保存图形为 PDF
save_plot_as_pdf <- function(plot_obj, filename, width = 8, height = 6) {
tryCatch({
ggsave(filename = filename,
plot = plot_obj,
device = "pdf",
width = width,
height = height)
message(paste("Saved PDF:", filename))
}, error = function(e) {
message(paste("Failed to save PDF:", filename, "-", e$message))
})
}
# 辅助函数：生成唯一文件名并保存图形
save_current_plot <- function(plot_obj, base_filename, width = 8, height = 6) {
timestamp <- format(Sys.time(), "%Y%m%d_%H%M%S")
pdf_filename <- paste0("pdf_outputs/", base_filename, "_", timestamp, ".pdf")
save_plot_as_pdf(plot_obj, pdf_filename, width, height)
}
# 1. Plot Cell Counts by Condition
output$plot_counts <- renderPlot({
req(sce_reactive())
plot <- plotCounts(sce_reactive(), color_by = "condition", group_by = "sample_id", prop = FALSE)
print(plot)
save_current_plot(plot, "plot_counts")
})
# 2. Plot MDS
output$plot_mds <- renderPlot({
req(sce_reactive())
plot <- pbMDS(sce_reactive(), color_by = "condition")
print(plot)
save_current_plot(plot, "plot_mds")
})
# 3. Expression Heatmap
output$plot_heatmap <- renderPlot({
req(sce_reactive())
plot <- plotExprHeatmap(sce_reactive(), bin_anno = TRUE, row_anno = TRUE)
print(plot)
save_current_plot(plot, "plot_heatmap", width = 10, height = 8)
})
# 4. Expression Boxplot (基础 R 绘图示例)
output$plot_exprs <- renderPlot({
req(sce_reactive())
# 生成唯一的文件名
timestamp <- format(Sys.time(), "%Y%m%d_%H%M%S")
pdf_filename <- paste0("pdf_outputs/plot_exprs_", timestamp, ".pdf")
# 打开PDF设备
pdf(pdf_filename, width = 8, height = 6)
# 绘制图形
plotExprs(sce_reactive(), color_by = "condition")
# 关闭设备
dev.off()
# 同时在Shiny中显示图形
plotExprs(sce_reactive(), color_by = "condition")
})
# 其他 renderPlot 和功能代码...
# 示例：在分析完成后生成所有 PDF 报告
observeEvent(input$btn_analysis_run, {
withProgress(message = "Generating PDF reports...", value = 0, {
# 生成 plot_counts PDF
incProgress(0.2, detail = "Generating plot_counts PDF...")
plot_counts_plot <- plotCounts(sce_reactive(), color_by = "condition", group_by = "sample_id", prop = FALSE)
save_current_plot(plot_counts_plot, "plot_counts")
# 生成 plot_mds PDF
incProgress(0.2, detail = "Generating plot_mds PDF...")
plot_mds_plot <- pbMDS(sce_reactive(), color_by = "condition")
save_current_plot(plot_mds_plot, "plot_mds")
# 生成 plot_heatmap PDF
incProgress(0.2, detail = "Generating plot_heatmap PDF...")
plot_heatmap_plot <- plotExprHeatmap(sce_reactive(), bin_anno = TRUE, row_anno = TRUE)
save_current_plot(plot_heatmap_plot, "plot_heatmap", width = 10, height = 8)
# 添加其他图形的保存操作
# ...
incProgress(0.4, detail = "Finalizing PDF reports...")
showNotification("All PDF reports generated successfully!", type = "message")
})
})
# 其他服务器逻辑...
}
